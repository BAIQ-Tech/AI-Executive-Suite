<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Effectiveness - AI Executive Suite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .effectiveness-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .effectiveness-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .effectiveness-title {
            font-size: 2.5em;
            color: #2c3e50;
            margin: 0;
        }
        
        .tracking-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .outcome-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
        }
        
        .rating-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .rating-star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .rating-star.active {
            color: #f39c12;
        }
        
        .rating-star:hover {
            color: #f39c12;
        }
        
        .rating-label {
            margin-left: 10px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .effectiveness-report {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-value.grade-a { color: #27ae60; }
        .metric-value.grade-b { color: #2ecc71; }
        .metric-value.grade-c { color: #f39c12; }
        .metric-value.grade-d { color: #e67e22; }
        .metric-value.grade-f { color: #e74c3c; }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .improvement-areas {
            margin-top: 20px;
        }
        
        .improvement-list {
            list-style: none;
            padding: 0;
        }
        
        .improvement-item {
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 3px solid #e74c3c;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .improvement-icon {
            color: #e74c3c;
            font-size: 18px;
        }
        
        .decision-selector {
            margin-bottom: 20px;
        }
        
        .decision-search {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .decision-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .decision-option {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .decision-option:hover {
            background-color: #f8f9fa;
        }
        
        .decision-option:last-child {
            border-bottom: none;
        }
        
        .decision-option.selected {
            background-color: #e8f4fd;
            border-left: 3px solid #3498db;
        }
        
        .decision-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .decision-meta {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            background: #fdeaea;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success-message {
            background: #d5f4e6;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .effectiveness-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .outcome-form {
                grid-template-columns: 1fr;
            }
            
            .report-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="effectiveness-container">
        <div class="effectiveness-header">
            <h1 class="effectiveness-title">Decision Effectiveness Tracking</h1>
            <div>
                <a href="/analytics/dashboard" class="btn btn-primary">Dashboard</a>
                <a href="/analytics/reports" class="btn btn-secondary">Reports</a>
                <a href="/" class="btn btn-secondary">Home</a>
            </div>
        </div>

        <!-- Record Outcome Section -->
        <div class="tracking-section">
            <h2 class="section-title">
                üìù Record Decision Outcome
            </h2>
            
            <div class="success-message" id="successMessage">
                Outcome recorded successfully!
            </div>
            
            <div class="decision-selector">
                <input type="text" id="decisionSearch" class="decision-search" 
                       placeholder="Search for a decision to rate...">
                <div id="decisionList" class="decision-list" style="display: none;">
                    <!-- Decision options will be populated here -->
                </div>
            </div>
            
            <form id="outcomeForm" style="display: none;">
                <div class="outcome-form">
                    <div class="form-group">
                        <label class="form-label">Outcome Rating</label>
                        <div class="rating-input">
                            <span class="rating-star" data-rating="1">‚òÖ</span>
                            <span class="rating-star" data-rating="2">‚òÖ</span>
                            <span class="rating-star" data-rating="3">‚òÖ</span>
                            <span class="rating-star" data-rating="4">‚òÖ</span>
                            <span class="rating-star" data-rating="5">‚òÖ</span>
                            <span class="rating-label" id="ratingLabel">Select a rating</span>
                        </div>
                        <input type="hidden" id="outcomeRating" name="outcome_rating">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="financialImpact">Actual Financial Impact ($)</label>
                        <input type="number" id="financialImpact" name="financial_impact" 
                               class="form-input" step="0.01" placeholder="Optional">
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label" for="outcomeNotes">Outcome Notes</label>
                        <textarea id="outcomeNotes" name="outcome_notes" class="form-textarea" 
                                  placeholder="Describe what happened, lessons learned, etc."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Record Outcome</button>
                <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
            </form>
        </div>

        <!-- Effectiveness Report Section -->
        <div class="tracking-section" id="reportSection" style="display: none;">
            <h2 class="section-title">
                üìä Effectiveness Report
            </h2>
            
            <div id="effectivenessReport" class="effectiveness-report">
                <!-- Report content will be populated here -->
            </div>
        </div>
    </div>

    <script>
        class EffectivenessTracker {
            constructor() {
                this.selectedDecision = null;
                this.currentRating = 0;
                this.decisions = [];
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadDecisions();
            }

            bindEvents() {
                // Decision search
                document.getElementById('decisionSearch').addEventListener('input', (e) => {
                    this.filterDecisions(e.target.value);
                });

                document.getElementById('decisionSearch').addEventListener('focus', () => {
                    document.getElementById('decisionList').style.display = 'block';
                });

                // Rating stars
                document.querySelectorAll('.rating-star').forEach(star => {
                    star.addEventListener('click', (e) => {
                        this.setRating(parseInt(e.target.dataset.rating));
                    });

                    star.addEventListener('mouseover', (e) => {
                        this.highlightRating(parseInt(e.target.dataset.rating));
                    });
                });

                document.querySelector('.rating-input').addEventListener('mouseleave', () => {
                    this.highlightRating(this.currentRating);
                });

                // Form submission
                document.getElementById('outcomeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitOutcome();
                });

                // Cancel button
                document.getElementById('cancelBtn').addEventListener('click', () => {
                    this.resetForm();
                });

                // Click outside to close decision list
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.decision-selector')) {
                        document.getElementById('decisionList').style.display = 'none';
                    }
                });
            }

            async loadDecisions() {
                try {
                    // Load recent decisions that might need outcome tracking
                    const response = await fetch('/analytics/api/decision-analytics?days=90');
                    if (!response.ok) throw new Error('Failed to fetch decisions');
                    
                    // For now, we'll create mock decisions since we don't have a direct endpoint
                    // In a real implementation, you'd have an endpoint that returns decisions needing rating
                    this.decisions = this.generateMockDecisions();
                    this.renderDecisionList();

                } catch (error) {
                    console.error('Error loading decisions:', error);
                    this.decisions = this.generateMockDecisions();
                    this.renderDecisionList();
                }
            }

            generateMockDecisions() {
                return [
                    {
                        id: 1,
                        title: "Implement new customer onboarding process",
                        executive_type: "ceo",
                        created_at: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                        category: "strategic",
                        implemented_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        outcome_rating: null
                    },
                    {
                        id: 2,
                        title: "Upgrade database infrastructure",
                        executive_type: "cto",
                        created_at: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
                        category: "technical",
                        implemented_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                        outcome_rating: null
                    },
                    {
                        id: 3,
                        title: "Optimize marketing budget allocation",
                        executive_type: "cfo",
                        created_at: new Date(Date.now() - 21 * 24 * 60 * 60 * 1000).toISOString(),
                        category: "financial",
                        implemented_at: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                        outcome_rating: null
                    }
                ];
            }

            renderDecisionList() {
                const list = document.getElementById('decisionList');
                list.innerHTML = '';

                this.decisions.forEach(decision => {
                    const option = document.createElement('div');
                    option.className = 'decision-option';
                    option.dataset.decisionId = decision.id;
                    
                    const createdDate = new Date(decision.created_at).toLocaleDateString();
                    const executiveType = decision.executive_type ? decision.executive_type.toUpperCase() : 'Unknown';
                    
                    option.innerHTML = `
                        <div class="decision-title">${decision.title}</div>
                        <div class="decision-meta">
                            ${executiveType} ‚Ä¢ ${createdDate} ‚Ä¢ ${decision.category || 'Uncategorized'}
                        </div>
                    `;
                    
                    option.addEventListener('click', () => {
                        this.selectDecision(decision);
                    });
                    
                    list.appendChild(option);
                });
            }

            filterDecisions(searchTerm) {
                const options = document.querySelectorAll('.decision-option');
                options.forEach(option => {
                    const title = option.querySelector('.decision-title').textContent.toLowerCase();
                    const meta = option.querySelector('.decision-meta').textContent.toLowerCase();
                    const matches = title.includes(searchTerm.toLowerCase()) || 
                                   meta.includes(searchTerm.toLowerCase());
                    option.style.display = matches ? 'block' : 'none';
                });
            }

            selectDecision(decision) {
                this.selectedDecision = decision;
                
                // Update UI
                document.getElementById('decisionSearch').value = decision.title;
                document.getElementById('decisionList').style.display = 'none';
                document.getElementById('outcomeForm').style.display = 'block';
                
                // Clear previous selections
                document.querySelectorAll('.decision-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Mark selected
                document.querySelector(`[data-decision-id="${decision.id}"]`).classList.add('selected');
                
                // Reset form
                this.resetFormFields();
            }

            setRating(rating) {
                this.currentRating = rating;
                document.getElementById('outcomeRating').value = rating;
                this.highlightRating(rating);
                this.updateRatingLabel(rating);
            }

            highlightRating(rating) {
                document.querySelectorAll('.rating-star').forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }

            updateRatingLabel(rating) {
                const labels = {
                    1: 'Poor - Did not meet expectations',
                    2: 'Below Average - Partially successful',
                    3: 'Average - Met basic expectations',
                    4: 'Good - Exceeded expectations',
                    5: 'Excellent - Outstanding results'
                };
                
                document.getElementById('ratingLabel').textContent = labels[rating] || 'Select a rating';
            }

            async submitOutcome() {
                if (!this.selectedDecision || !this.currentRating) {
                    alert('Please select a decision and provide a rating.');
                    return;
                }

                try {
                    const formData = {
                        decision_id: this.selectedDecision.id,
                        outcome_rating: this.currentRating,
                        outcome_notes: document.getElementById('outcomeNotes').value,
                        financial_impact: document.getElementById('financialImpact').value || null
                    };

                    const response = await fetch('/analytics/api/record-outcome', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to record outcome');
                    }

                    // Show success message
                    this.showSuccessMessage();
                    
                    // Load and show effectiveness report
                    await this.loadEffectivenessReport(this.selectedDecision.id);
                    
                    // Reset form
                    this.resetForm();

                } catch (error) {
                    console.error('Error recording outcome:', error);
                    alert('Failed to record outcome. Please try again.');
                }
            }

            async loadEffectivenessReport(decisionId) {
                try {
                    const response = await fetch(`/analytics/api/effectiveness-report/${decisionId}`);
                    if (!response.ok) throw new Error('Failed to fetch report');
                    
                    const report = await response.json();
                    this.renderEffectivenessReport(report);
                    document.getElementById('reportSection').style.display = 'block';

                } catch (error) {
                    console.error('Error loading effectiveness report:', error);
                    // Show mock report for demo
                    this.renderMockEffectivenessReport();
                    document.getElementById('reportSection').style.display = 'block';
                }
            }

            renderEffectivenessReport(report) {
                const reportDiv = document.getElementById('effectivenessReport');
                
                reportDiv.innerHTML = `
                    <div class="report-grid">
                        <div class="metric-card">
                            <div class="metric-value grade-${report.overall_grade.toLowerCase()}">${report.overall_grade}</div>
                            <div class="metric-label">Overall Grade</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${(report.effectiveness_score * 100).toFixed(0)}%</div>
                            <div class="metric-label">Effectiveness Score</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${(report.implementation_timeliness * 100).toFixed(0)}%</div>
                            <div class="metric-label">Timeliness</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${(report.confidence_alignment * 100).toFixed(0)}%</div>
                            <div class="metric-label">Confidence Alignment</div>
                        </div>
                    </div>
                    
                    ${report.improvement_areas.length > 0 ? `
                        <div class="improvement-areas">
                            <h4>Areas for Improvement</h4>
                            <ul class="improvement-list">
                                ${report.improvement_areas.map(area => `
                                    <li class="improvement-item">
                                        <span class="improvement-icon">‚ö†</span>
                                        ${area}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : '<p>No specific improvement areas identified. Great job!</p>'}
                `;
            }

            renderMockEffectivenessReport() {
                const mockReport = {
                    overall_grade: 'B',
                    effectiveness_score: 0.78,
                    implementation_timeliness: 0.85,
                    confidence_alignment: 0.72,
                    improvement_areas: [
                        'Consider gathering more stakeholder feedback before implementation',
                        'Set more specific success metrics for future decisions'
                    ]
                };
                
                this.renderEffectivenessReport(mockReport);
            }

            showSuccessMessage() {
                const message = document.getElementById('successMessage');
                message.style.display = 'block';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
            }

            resetForm() {
                this.selectedDecision = null;
                this.currentRating = 0;
                this.resetFormFields();
                document.getElementById('outcomeForm').style.display = 'none';
                document.getElementById('reportSection').style.display = 'none';
                document.getElementById('decisionSearch').value = '';
                
                // Clear selection
                document.querySelectorAll('.decision-option').forEach(option => {
                    option.classList.remove('selected');
                });
            }

            resetFormFields() {
                document.getElementById('outcomeRating').value = '';
                document.getElementById('financialImpact').value = '';
                document.getElementById('outcomeNotes').value = '';
                this.highlightRating(0);
                this.updateRatingLabel(0);
            }
        }

        // Initialize effectiveness tracker when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EffectivenessTracker();
        });
    </script>
</body>
</html>