<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - AI Executive Suite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        .analytics-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .dashboard-title {
            font-size: 2.5em;
            color: #2c3e50;
            margin: 0;
        }
        
        .dashboard-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            font-size: 14px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .metric-card.success {
            border-left-color: #27ae60;
        }
        
        .metric-card.warning {
            border-left-color: #f39c12;
        }
        
        .metric-card.danger {
            border-left-color: #e74c3c;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 1.1em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-change {
            font-size: 0.9em;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        .metric-change.positive {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .metric-change.negative {
            background: #fdeaea;
            color: #e74c3c;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-canvas {
            max-height: 400px;
        }
        
        .alerts-section {
            margin-bottom: 30px;
        }
        
        .alerts-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .alert.info {
            background: #e8f4fd;
            border-left-color: #3498db;
            color: #2980b9;
        }
        
        .alert.warning {
            background: #fef9e7;
            border-left-color: #f39c12;
            color: #d68910;
        }
        
        .alert.danger {
            background: #fdeaea;
            border-left-color: #e74c3c;
            color: #c0392b;
        }
        
        .alert.success {
            background: #d5f4e6;
            border-left-color: #27ae60;
            color: #229954;
        }
        
        .recommendations-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .recommendations-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .recommendations-list {
            list-style: none;
            padding: 0;
        }
        
        .recommendation-item {
            padding: 12px 0;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .recommendation-item:last-child {
            border-bottom: none;
        }
        
        .recommendation-icon {
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            background: #fdeaea;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .dashboard-filters {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="analytics-dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Analytics Dashboard</h1>
            <div class="dashboard-filters">
                <select id="timeRange" class="filter-select">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
                <button id="refreshBtn" class="btn btn-primary">Refresh</button>
                <a href="/" class="btn btn-secondary">Back to Home</a>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            <p>Loading dashboard data...</p>
        </div>

        <div id="errorMessage" class="error" style="display: none;">
            <p>Error loading dashboard data. Please try again.</p>
        </div>

        <div id="dashboardContent" style="display: none;">
            <!-- Key Metrics -->
            <div class="metrics-grid" id="metricsGrid">
                <!-- Metrics will be populated by JavaScript -->
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Decisions Over Time</h3>
                    <canvas id="decisionsChart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Decisions by Executive</h3>
                    <canvas id="executiveChart" class="chart-canvas"></canvas>
                </div>
            </div>

            <!-- Alerts -->
            <div class="alerts-section">
                <div id="alertsContainer" class="alerts-container">
                    <!-- Alerts will be populated by JavaScript -->
                </div>
            </div>

            <!-- Recommendations -->
            <div class="recommendations-section">
                <h3 class="recommendations-title">Recommendations</h3>
                <ul id="recommendationsList" class="recommendations-list">
                    <!-- Recommendations will be populated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        class AnalyticsDashboard {
            constructor() {
                this.charts = {};
                this.currentTimeRange = 30;
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadDashboardData();
            }

            bindEvents() {
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadDashboardData();
                });

                document.getElementById('timeRange').addEventListener('change', (e) => {
                    this.currentTimeRange = parseInt(e.target.value);
                    this.loadDashboardData();
                });
            }

            async loadDashboardData() {
                try {
                    this.showLoading();
                    
                    const [dashboardResponse, analyticsResponse] = await Promise.all([
                        fetch('/analytics/api/dashboard-data'),
                        fetch(`/analytics/api/decision-analytics?days=${this.currentTimeRange}`)
                    ]);

                    if (!dashboardResponse.ok || !analyticsResponse.ok) {
                        throw new Error('Failed to fetch data');
                    }

                    const dashboardData = await dashboardResponse.json();
                    const analyticsData = await analyticsResponse.json();

                    this.renderDashboard(dashboardData, analyticsData);
                    this.hideLoading();

                } catch (error) {
                    console.error('Error loading dashboard:', error);
                    this.showError();
                }
            }

            renderDashboard(dashboardData, analyticsData) {
                this.renderMetrics(dashboardData.key_metrics, analyticsData);
                this.renderCharts(dashboardData.charts, analyticsData);
                this.renderAlerts(dashboardData.alerts);
                this.renderRecommendations(dashboardData.recommendations);
            }

            renderMetrics(keyMetrics, analyticsData) {
                const metricsGrid = document.getElementById('metricsGrid');
                metricsGrid.innerHTML = '';

                const metrics = [
                    {
                        label: 'Total Decisions',
                        value: analyticsData.total_decisions || keyMetrics.total_decisions || 0,
                        type: 'info'
                    },
                    {
                        label: 'Success Rate',
                        value: `${((keyMetrics.success_rate || 0) * 100).toFixed(1)}%`,
                        type: (keyMetrics.success_rate || 0) >= 0.7 ? 'success' : 'warning'
                    },
                    {
                        label: 'Avg Confidence',
                        value: ((keyMetrics.avg_confidence || 0) * 100).toFixed(0) + '%',
                        type: (keyMetrics.avg_confidence || 0) >= 0.7 ? 'success' : 'warning'
                    },
                    {
                        label: 'Implementation Rate',
                        value: `${((analyticsData.implementation_rate || keyMetrics.implementation_rate || 0) * 100).toFixed(1)}%`,
                        type: (analyticsData.implementation_rate || keyMetrics.implementation_rate || 0) >= 0.8 ? 'success' : 'warning'
                    }
                ];

                metrics.forEach(metric => {
                    const metricCard = document.createElement('div');
                    metricCard.className = `metric-card ${metric.type}`;
                    metricCard.innerHTML = `
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    `;
                    metricsGrid.appendChild(metricCard);
                });
            }

            renderCharts(dashboardCharts, analyticsData) {
                // Decisions over time chart
                this.renderDecisionsChart(analyticsData.decisions_over_time || []);
                
                // Executive distribution chart
                this.renderExecutiveChart(analyticsData.decisions_by_executive || {});
            }

            renderDecisionsChart(timeSeriesData) {
                const ctx = document.getElementById('decisionsChart').getContext('2d');
                
                if (this.charts.decisions) {
                    this.charts.decisions.destroy();
                }

                const labels = timeSeriesData.map(point => {
                    const date = new Date(point.timestamp);
                    return date.toLocaleDateString();
                });
                
                const data = timeSeriesData.map(point => point.value);

                this.charts.decisions = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Decisions',
                            data: data,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            renderExecutiveChart(executiveData) {
                const ctx = document.getElementById('executiveChart').getContext('2d');
                
                if (this.charts.executive) {
                    this.charts.executive.destroy();
                }

                const labels = Object.keys(executiveData).map(key => key.toUpperCase());
                const data = Object.values(executiveData);
                const colors = ['#3498db', '#e74c3c', '#f39c12', '#27ae60', '#9b59b6'];

                this.charts.executive = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            renderAlerts(alerts) {
                const alertsContainer = document.getElementById('alertsContainer');
                alertsContainer.innerHTML = '';

                if (!alerts || alerts.length === 0) {
                    const noAlerts = document.createElement('div');
                    noAlerts.className = 'alert success';
                    noAlerts.innerHTML = '<span>✓</span> All systems operating normally';
                    alertsContainer.appendChild(noAlerts);
                    return;
                }

                alerts.forEach(alert => {
                    const alertElement = document.createElement('div');
                    alertElement.className = `alert ${alert.type}`;
                    
                    const icon = alert.type === 'warning' ? '⚠' : 
                                alert.type === 'danger' ? '✗' : 
                                alert.type === 'success' ? '✓' : 'ℹ';
                    
                    alertElement.innerHTML = `<span>${icon}</span> ${alert.message}`;
                    alertsContainer.appendChild(alertElement);
                });
            }

            renderRecommendations(recommendations) {
                const recommendationsList = document.getElementById('recommendationsList');
                recommendationsList.innerHTML = '';

                if (!recommendations || recommendations.length === 0) {
                    const noRecommendations = document.createElement('li');
                    noRecommendations.className = 'recommendation-item';
                    noRecommendations.innerHTML = `
                        <div class="recommendation-icon">✓</div>
                        <span>No specific recommendations at this time. Keep up the good work!</span>
                    `;
                    recommendationsList.appendChild(noRecommendations);
                    return;
                }

                recommendations.forEach((recommendation, index) => {
                    const recommendationItem = document.createElement('li');
                    recommendationItem.className = 'recommendation-item';
                    recommendationItem.innerHTML = `
                        <div class="recommendation-icon">${index + 1}</div>
                        <span>${recommendation}</span>
                    `;
                    recommendationsList.appendChild(recommendationItem);
                });
            }

            showLoading() {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
            }

            showError() {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('dashboardContent').style.display = 'none';
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AnalyticsDashboard();
        });
    </script>
</body>
</html>